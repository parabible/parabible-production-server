"use strict";

var _express = _interopRequireDefault(require("express"));

var _compression = _interopRequireDefault(require("compression"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _cors = _interopRequireDefault(require("cors"));

var _chapterText = require("./api/chapter-text");

var _wordLookup = require("./api/word-lookup");

var _termSearch = require("./api/term-search");

var _logging = _interopRequireDefault(require("./util/logging"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var MongoClient = require('mongodb').MongoClient;

let things = {
  mongo: false,
  express: false
};
console.log("WAITING:", Object.keys(things));

const declare_ready = thing => {
  console.log("READY:", thing);
  things[thing] = true;

  if (Object.keys(things).reduce((c, k) => c && things[k], true)) {
    console.log("READY READY READY!");
  }
};

const requiredEnvVar = variable => {
  if (!process.env.hasOwnProperty(variable)) {
    console.log(`Sorry, we need "${variable}" to be set`);
    process.exit();
  }

  return process.env[variable];
};

const mongoConnectionString = requiredEnvVar("MONGO_CONNECTION_STRING");
const mongoDatabase = requiredEnvVar("MONGO_DATABASE");
const mongoUrl = `mongodb://${mongoConnectionString}/${mongoDatabase}`;
let mongoConnection = null;
MongoClient.connect(mongoUrl, (err, db) => {
  if (err) {
    console.log("Error setting up mongo connection");
    console.log(err);
  } else {
    mongoConnection = db;
    declare_ready("mongo");
  }
});
let app = (0, _express.default)();
app.use((0, _compression.default)());
app.use(_bodyParser.default.json());
app.use((0, _cors.default)());
let port = +process.env.PORT || 3000;
let host = process.env.HOST || "127.0.0.1";
let server = app.listen(port, host, () => {
  console.log("Server listening to %s:%d within %s environment", host, port, app.get('env'));
  declare_ready("express");
}); // Use X-Forwarded-For

app.set('trust proxy', 'loopback');
console.log("Setting up routes");
app.post(['/api', '/api/*'], (req, res) => {
  const api_request = req.params;
  const params = req.body;
  console.log(api_request[0]);
  (0, _logging.default)({
    api_request,
    params,
    ip_address: req.ip
  });
  let responsePromise = new Promise((resolve, reject) => resolve());

  switch (api_request[0]) {
    case "term-search":
      responsePromise = (0, _termSearch.termSearch)(params, mongoConnection);
      break;

    case "collocation-search":
      responsePromise = (0, _termSearch.collocationSearch)(params); // response = termSearch(params) 

      break;

    case "word-study":
      // response = termSearch(params) 
      break;

    case "word-lookup":
      responsePromise = (0, _wordLookup.wordLookup)(params, mongoConnection);
      break;

    case "term-highlights":
      // response = termSearch(params) 
      break;

    case "chapter-text":
      responsePromise = (0, _chapterText.chapterText)(params, mongoConnection);
      break;

    default:
      responsePromise = new Promise((resolve, reject) => {
        reject({
          "error": "Invalid api request. Request should be formatted /api/<type of request>",
          "options": ["term-search", "collocation-search", "word-study", "word-lookup", "term-highlights", "chapter-text"]
        });
      });
      break;
  }

  responsePromise.then(response => {
    res.send(response);
  }).catch(response => {
    res.status(500).send(response);
    console.log("error");
    console.log(response);
  });
}); // const clientRoot = "./client/build"

const clientRoot = requiredEnvVar("PARABIBLE_CLIENT_DIR");

const getUrl = mobile => {
  if (mobile) return '/mobile.html';else return '/index.html';
};

const needsFonts = userAgent => {
  // technically this is not mobile - it's whether or not to dump fonts into the index.html
  const regexForMobile = {
    // Windows: /windows nt/i,
    WindowsPhone: /windows phone/i,
    // Mac: /macintosh/i,
    // Linux: /linux/i,
    Wii: /wii/i,
    Playstation: /playstation/i,
    iPad: /ipad/i,
    iPod: /ipod/i,
    iPhone: /iphone/i,
    Android: /android/i,
    Blackberry: /blackberry/i,
    Samsung: /samsung/i,
    // Curl: /curl/i
    Mobile: /mobile/i
  };
  return Object.keys(regexForMobile).reduce((a, k) => a || regexForMobile[k].test(userAgent), false);
}; // Route order matters - the first listed will be invoked


app.get("/", (req, res) => {
  res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), {
    root: clientRoot
  });
});
app.use(_express.default.static(clientRoot));
app.get("*", (req, res) => {
  res.sendFile(getUrl(needsFonts(req.headers["user-agent"])), {
    root: clientRoot
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLmpzIl0sIm5hbWVzIjpbIk1vbmdvQ2xpZW50IiwicmVxdWlyZSIsInRoaW5ncyIsIm1vbmdvIiwiZXhwcmVzcyIsImNvbnNvbGUiLCJsb2ciLCJPYmplY3QiLCJrZXlzIiwiZGVjbGFyZV9yZWFkeSIsInRoaW5nIiwicmVkdWNlIiwiYyIsImsiLCJyZXF1aXJlZEVudlZhciIsInZhcmlhYmxlIiwicHJvY2VzcyIsImVudiIsImhhc093blByb3BlcnR5IiwiZXhpdCIsIm1vbmdvQ29ubmVjdGlvblN0cmluZyIsIm1vbmdvRGF0YWJhc2UiLCJtb25nb1VybCIsIm1vbmdvQ29ubmVjdGlvbiIsImNvbm5lY3QiLCJlcnIiLCJkYiIsImFwcCIsInVzZSIsImJvZHlQYXJzZXIiLCJqc29uIiwicG9ydCIsIlBPUlQiLCJob3N0IiwiSE9TVCIsInNlcnZlciIsImxpc3RlbiIsImdldCIsInNldCIsInBvc3QiLCJyZXEiLCJyZXMiLCJhcGlfcmVxdWVzdCIsInBhcmFtcyIsImJvZHkiLCJpcF9hZGRyZXNzIiwiaXAiLCJyZXNwb25zZVByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInRoZW4iLCJyZXNwb25zZSIsInNlbmQiLCJjYXRjaCIsInN0YXR1cyIsImNsaWVudFJvb3QiLCJnZXRVcmwiLCJtb2JpbGUiLCJuZWVkc0ZvbnRzIiwidXNlckFnZW50IiwicmVnZXhGb3JNb2JpbGUiLCJXaW5kb3dzUGhvbmUiLCJXaWkiLCJQbGF5c3RhdGlvbiIsImlQYWQiLCJpUG9kIiwiaVBob25lIiwiQW5kcm9pZCIsIkJsYWNrYmVycnkiLCJTYW1zdW5nIiwiTW9iaWxlIiwiYSIsInRlc3QiLCJzZW5kRmlsZSIsImhlYWRlcnMiLCJyb290Iiwic3RhdGljIl0sIm1hcHBpbmdzIjoiOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBVkEsSUFBSUEsV0FBVyxHQUFHQyxPQUFPLENBQUMsU0FB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Q0MsSUFBUCxDQUFZcUQsY0FBWixFQUE0QmxELE1BQTVCLENBQW1DLENBQUM2RCxDQUFELEVBQUkzRCxDQUFKLEtBQ3pDMkQsQ0FBQyxJQUFJWCxjQUFjLENBQUNoRCxDQUFELENBQWQsQ0FBa0I0RCxJQUFsQixDQUF1QmIsU0FBdkIsQ0FEQyxFQUVQLEtBRk8sQ0FBUDtBQUdBLENBckJELEMsQ0F1QkE7OztBQUNBakMsR0FBRyxDQUFDVSxHQUFKLENBQVEsR0FBUixFQUFhLENBQUNHLEdBQUQsRUFBTUMsR0FBTixLQUFjO0FBQzFCQSxFQUFBQSxHQUFHLENBQUNpQyxRQUFKLENBQWFqQixNQUFNLENBQUNFLFVBQVUsQ0FBQ25CLEdBQUcsQ0FBQ21DLE9BQUosQ0FBWSxZQUFaLENBQUQsQ0FBWCxDQUFuQixFQUE0RDtBQUFDQyxJQUFBQSxJQUFJLEVBQUVwQjtBQUFQLEdBQTVEO0FBQ0EsQ0FGRDtBQUdBN0IsR0FBRyxDQUFDQyxHQUFKLENBQVF4QixpQkFBUXlFLE1BQVIsQ0FBZXJCLFVBQWYsQ0FBUjtBQUNBN0IsR0FBRyxDQUFDVSxHQUFKLENBQVEsR0FBUixFQUFhLENBQUNHLEdBQUQsRUFBTUMsR0FBTixLQUFjO0FBQzFCQSxFQUFBQSxHQUFHLENBQUNpQyxRQUFKLENBQWFqQixNQUFNLENBQUNFLFVBQVUsQ0FBQ25CLEdBQUcsQ0FBQ21DLE9BQUosQ0FBWSxZQUFaLENBQUQsQ0FBWCxDQUFuQixFQUE0RDtBQUFDQyxJQUFBQSxJQUFJLEVBQUVwQjtBQUFQLEdBQTVEO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbInZhciBNb25nb0NsaWVudCA9IHJlcXVpcmUoJ21vbmdvZGInKS5Nb25nb0NsaWVudFxuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcydcbmltcG9ydCBjb21wcmVzc2lvbiBmcm9tICdjb21wcmVzc2lvbidcbmltcG9ydCBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJ1xuaW1wb3J0IGNvcnMgZnJvbSAnY29ycydcblxuaW1wb3J0IHsgY2hhcHRlclRleHQgfSBmcm9tIFwiLi9hcGkvY2hhcHRlci10ZXh0XCJcbmltcG9ydCB7IHdvcmRMb29rdXAgfSBmcm9tIFwiLi9hcGkvd29yZC1sb29rdXBcIlxuaW1wb3J0IHsgdGVybVNlYXJjaCwgY29sbG9jYXRpb25TZWFyY2ggfSBmcm9tIFwiLi9hcGkvdGVybS1zZWFyY2hcIlxuXG5pbXBvcnQgTG9nIGZyb20gXCIuL3V0aWwvbG9nZ2luZ1wiXG5cbmxldCB0aGluZ3MgPSB7XG5cdG1vbmdvOiBmYWxzZSxcblx0ZXhwcmVzczogZmFsc2Vcbn1cbmNvbnNvbGUubG9nKFwiV0FJVElORzpcIiwgT2JqZWN0LmtleXModGhpbmdzKSlcbmNvbnN0IGRlY2xhcmVfcmVhZHkgPSAodGhpbmcpID0+IHtcblx0Y29uc29sZS5sb2coXCJSRUFEWTpcIiwgdGhpbmcpXG5cdHRoaW5nc1t0aGluZ10gPSB0cnVlXG5cdGlmIChPYmplY3Qua2V5cyh0aGluZ3MpLnJlZHVjZSgoYywgaykgPT4gYyAmJiB0aGluZ3Nba10sIHRydWUpKSB7XG5cdFx0Y29uc29sZS5sb2coXCJSRUFEWSBSRUFEWSBSRUFEWSFcIilcblx0fVxufVxuXG5cbmNvbnN0IHJlcXVpcmVkRW52VmFyID0gKHZhcmlhYmxlKSA9PiB7XG5cdGlmICghcHJvY2Vzcy5lbnYuaGFzT3duUHJvcGVydHkodmFyaWFibGUpKSB7XG5cdFx0Y29uc29sZS5sb2coYFNvcnJ5LCB3ZSBuZWVkIFwiJHt2YXJpYWJsZX1cIiB0byBiZSBzZXRgKVxuXHRcdHByb2Nlc3MuZXhpdCgpXG5cdH1cblx0cmV0dXJuIHByb2Nlc3MuZW52W3ZhcmlhYmxlXVxufVxuXG5jb25zdCBtb25nb0Nvbm5lY3Rpb25TdHJpbmcgPSByZXF1aXJlZEVudlZhcihcIk1PTkdPX0NPTk5FQ1RJT05fU1RSSU5HXCIpXG5jb25zdCBtb25nb0RhdGFiYXNlID0gcmVxdWlyZWRFbnZWYXIoXCJNT05HT19EQVRBQkFTRVwiKVxuY29uc3QgbW9uZ29VcmwgPSBgbW9uZ29kYjovLyR7bW9uZ29Db25uZWN0aW9uU3RyaW5nfS8ke21vbmdvRGF0YWJhc2V9YFxuXG5sZXQgbW9uZ29Db25uZWN0aW9uID0gbnVsbDtcbk1vbmdvQ2xpZW50LmNvbm5lY3QobW9uZ29VcmwsIChlcnIsIGRiKSA9PiB7XG5cdGlmIChlcnIpIHtcblx0XHRjb25zb2xlLmxvZyhcIkVycm9yIHNldHRpbmcgdXAgbW9uZ28gY29ubmVjdGlvblwiKVxuXHRcdGNvbnNvbGUubG9nKGVycilcblx0fVxuXHRlbHNlIHtcblx0XHRtb25nb0Nvbm5lY3Rpb24gPSBkYlxuXHRcdGRlY2xhcmVfcmVhZHkoXCJtb25nb1wiKVxuXHR9XG59KVxuXG5sZXQgYXBwID0gZXhwcmVzcygpXG5hcHAudXNlKGNvbXByZXNzaW9uKCkpXG5hcHAudXNlKGJvZHlQYXJzZXIuanNvbigpKVxuYXBwLnVzZShjb3JzKCkpXG5sZXQgcG9ydCA9ICtwcm9jZXNzLmVudi5QT1JUIHx8IDMwMDBcbmxldCBob3N0ID0gcHJvY2Vzcy5lbnYuSE9TVCB8fCBcIjEyNy4wLjAuMVwiXG5sZXQgc2VydmVyID0gYXBwLmxpc3Rlbihwb3J0LCBob3N0LCAoKSA9PiB7XG5cdGNvbnNvbGUubG9nKFwiU2VydmVyIGxpc3RlbmluZyB0byAlczolZCB3aXRoaW4gJXMgZW52aXJvbm1lbnRcIiwgaG9zdCwgcG9ydCwgYXBwLmdldCgnZW52JykpXG5cdGRlY2xhcmVfcmVhZHkoXCJleHByZXNzXCIpXG59KVxuXG4vLyBVc2UgWC1Gb3J3YXJkZWQtRm9yXG5hcHAuc2V0KCd0cnVzdCBwcm94eScsICdsb29wYmFjaycpXG5cblxuY29uc29sZS5sb2coXCJTZXR0aW5nIHVwIHJvdXRlc1wiKVxuYXBwLnBvc3QoWycvYXBpJywgJy9hcGkvKiddLCAocmVxLCByZXMpID0+IHtcblx0Y29uc3QgYXBpX3JlcXVlc3QgPSByZXEucGFyYW1zXG5cdGNvbnN0IHBhcmFtcyA9IHJlcS5ib2R5XG5cdGNvbnNvbGUubG9nKGFwaV9yZXF1ZXN0WzBdKVxuXHRMb2coeyBhcGlfcmVxdWVzdCwgcGFyYW1zLCBpcF9hZGRyZXNzOiByZXEuaXAgfSlcblxuXHRsZXQgcmVzcG9uc2VQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gcmVzb2x2ZSgpKVxuXHRzd2l0Y2goYXBpX3JlcXVlc3RbMF0pIHtcblx0XHRjYXNlIFwidGVybS1zZWFyY2hcIjpcblx0XHRcdHJlc3BvbnNlUHJvbWlzZSA9IHRlcm1TZWFyY2gocGFyYW1zLCBtb25nb0Nvbm5lY3Rpb24pXG5cdFx0XHRicmVha1xuXHRcdGNhc2UgXCJjb2xsb2NhdGlvbi1zZWFyY2hcIjpcblx0XHRcdHJlc3BvbnNlUHJvbWlzZSA9IGNvbGxvY2F0aW9uU2VhcmNoKHBhcmFtcylcblx0XHRcdC8vIHJlc3BvbnNlID0gdGVybVNlYXJjaChwYXJhbXMpIFxuXHRcdFx0YnJlYWtcblx0XHRjYXNlIFwid29yZC1zdHVkeVwiOlxuXHRcdFx0Ly8gcmVzcG9uc2UgPSB0ZXJtU2VhcmNoKHBhcmFtcykgXG5cdFx0XHRicmVha1xuXHRcdGNhc2UgXCJ3b3JkLWxvb2t1cFwiOlxuXHRcdFx0cmVzcG9uc2VQcm9taXNlID0gd29yZExvb2t1cChwYXJhbXMsIG1vbmdvQ29ubmVjdGlvbikgXG5cdFx0XHRicmVha1xuXHRcdGNhc2UgXCJ0ZXJtLWhpZ2hsaWdodHNcIjpcblx0XHRcdC8vIHJlc3BvbnNlID0gdGVybVNlYXJjaChwYXJhbXMpIFxuXHRcdFx0YnJlYWtcblx0XHRjYXNlIFwiY2hhcHRlci10ZXh0XCI6XG5cdFx0XHRyZXNwb25zZVByb21pc2UgPSBjaGFwdGVyVGV4dChwYXJhbXMsIG1vbmdvQ29ubmVjdGlvbilcblx0XHRcdGJyZWFrXG5cdFx0ZGVmYXVsdDpcblx0XHRcdHJlc3BvbnNlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdFx0cmVqZWN0KHtcblx0XHRcdFx0XHRcImVycm9yXCI6IFwiSW52YWxpZCBhcGkgcmVxdWVzdC4gUmVxdWVzdCBzaG91bGQgYmUgZm9ybWF0dGVkIC9hcGkvPHR5cGUgb2YgcmVxdWVzdD5cIixcblx0XHRcdFx0XHRcIm9wdGlvbnNcIjogW1xuXHRcdFx0XHRcdFx0XCJ0ZXJtLXNlYXJjaFwiLFxuXHRcdFx0XHRcdFx0XCJjb2xsb2NhdGlvbi1zZWFyY2hcIixcblx0XHRcdFx0XHRcdFwid29yZC1zdHVkeVwiLFxuXHRcdFx0XHRcdFx0XCJ3b3JkLWxvb2t1cFwiLFxuXHRcdFx0XHRcdFx0XCJ0ZXJtLWhpZ2hsaWdodHNcIixcblx0XHRcdFx0XHRcdFwiY2hhcHRlci10ZXh0XCJcblx0XHRcdFx0XHRdXG5cdFx0XHRcdH0pXG5cdFx0XHR9KVxuXHRcdFx0YnJlYWtcblx0fVxuXHRyZXNwb25zZVByb21pc2UudGhlbigocmVzcG9uc2UpID0+IHtcblx0XHRyZXMuc2VuZChyZXNwb25zZSlcblx0fSkuY2F0Y2goKHJlc3BvbnNlKSA9PiB7XG5cdFx0cmVzLnN0YXR1cyg1MDApLnNlbmQocmVzcG9uc2UpXG5cdFx0Y29uc29sZS5sb2coXCJlcnJvclwiKVxuXHRcdGNvbnNvbGUubG9nKHJlc3BvbnNlKVxuXHR9KVxufSlcblxuXG4vLyBjb25zdCBjbGllbnRSb290ID0gXCIuL2NsaWVudC9idWlsZFwiXG5jb25zdCBjbGllbnRSb290ID0gcmVxdWlyZWRFbnZWYXIoXCJQQVJBQklCTEVfQ0xJRU5UX0RJUlwiKVxuY29uc3QgZ2V0VXJsID0gKG1vYmlsZSkgPT4ge1xuXHRpZiAobW9iaWxlKVxuXHRcdHJldHVybiAnL21vYmlsZS5odG1sJ1xuXHRlbHNlXG5cdFx0cmV0dXJuICcvaW5kZXguaHRtbCdcbn1cbmNvbnN0IG5lZWRzRm9udHMgPSAodXNlckFnZW50KSA9PiB7XG5cdC8vIHRlY2huaWNhbGx5IHRoaXMgaXMgbm90IG1vYmlsZSAtIGl0J3Mgd2hldGhlciBvciBub3QgdG8gZHVtcCBmb250cyBpbnRvIHRoZSBpbmRleC5odG1sXG5cdGNvbnN0IHJlZ2V4Rm9yTW9iaWxlID0ge1xuXHRcdC8vIFdpbmRvd3M6IC93aW5kb3dzIG50L2ksXG5cdFx0V2luZG93c1Bob25lOiAvd2luZG93cyBwaG9uZS9pLFxuXHRcdC8vIE1hYzogL21hY2ludG9zaC9pLFxuXHRcdC8vIExpbnV4OiAvbGludXgvaSxcblx0XHRXaWk6IC93aWkvaSxcblx0XHRQbGF5c3RhdGlvbjogL3BsYXlzdGF0aW9uL2ksXG5cdFx0aVBhZDogL2lwYWQvaSxcblx0XHRpUG9kOiAvaXBvZC9pLFxuXHRcdGlQaG9uZTogL2lwaG9uZS9pLFxuXHRcdEFuZHJvaWQ6IC9hbmRyb2lkL2ksXG5cdFx0QmxhY2tiZXJyeTogL2JsYWNrYmVycnkvaSxcblx0XHRTYW1zdW5nOiAvc2Ftc3VuZy9pLFxuXHRcdC8vIEN1cmw6IC9jdXJsL2lcblx0XHRNb2JpbGU6IC9tb2JpbGUvaVxuXHR9XG5cdHJldHVybiBPYmplY3Qua2V5cyhyZWdleEZvck1vYmlsZSkucmVkdWNlKChhLCBrKSA9PlxuXHRcdGEgfHwgcmVnZXhGb3JNb2JpbGVba10udGVzdCh1c2VyQWdlbnQpLFxuXHRmYWxzZSlcbn1cblxuLy8gUm91dGUgb3JkZXIgbWF0dGVycyAtIHRoZSBmaXJzdCBsaXN0ZWQgd2lsbCBiZSBpbnZva2VkXG5hcHAuZ2V0KFwiL1wiLCAocmVxLCByZXMpID0+IHtcblx0cmVzLnNlbmRGaWxlKGdldFVybChuZWVkc0ZvbnRzKHJlcS5oZWFkZXJzW1widXNlci1hZ2VudFwiXSkpLCB7cm9vdDogY2xpZW50Um9vdH0pXG59KVxuYXBwLnVzZShleHByZXNzLnN0YXRpYyhjbGllbnRSb290KSlcbmFwcC5nZXQoXCIqXCIsIChyZXEsIHJlcykgPT4ge1xuXHRyZXMuc2VuZEZpbGUoZ2V0VXJsKG5lZWRzRm9udHMocmVxLmhlYWRlcnNbXCJ1c2VyLWFnZW50XCJdKSksIHtyb290OiBjbGllbnRSb290fSlcbn0pXG4iXX0=
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports._wordsThatMatchQuery = exports.collocationSearch = exports.termSearch = void 0;

var _util = require("../util/util");

var _uniqueValuePerArray = require("../util/uniqueValuePerArray");

var _chapterText = require("./chapter-text");

var _word_data_map = _interopRequireDefault(require("../../data/word_data_map"));

var _tree_data = _interopRequireDefault(require("../../data/tree_data"));

var _range_node_data = _interopRequireDefault(require("../../data/range_node_data"));

var _book_names = _interopRequireDefault(require("../../data/book_names"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const RESULT_LIMIT = 500;
const doLog = false;

const consoleLog = (...debug) => {
  if (doLog) {
    console.log(...debug);
  }
};

const heatUpVerseWords = (verse_words, hot_set, lukewarm_set) => {
  return verse_words.map(accentUnit => accentUnit.map(w => {
    if (hot_set.has(w["wid"])) w["temperature"] = 2;else if (lukewarm_set.has(w["wid"])) w["temperature"] = 1;
    return w;
  }));
};

const _doFilter = (filter, wordNodes, chapterFilter = 0) => {
  if (filter.length > 0) {
    const chapterOffset = chapterFilter * 1000;
    const ridFilter = filter.map(f => _book_names.default[f] * 10000000 + chapterOffset);
    const extent = chapterFilter === 0 ? 10000000 : 1000;
    return wordNodes.filter(w => {
      const rid = _tree_data.default[w].verse;
      return ridFilter.reduce((a, v) => a || v <= rid && rid < v + extent, false);
    });
  } else {
    return wordNodes;
  }
};

const _wordsThatMatchQuery = (query, filter, chapterFilter = 0) => {
  let query_matches = [];
  Object.keys(query).forEach(k => {
    const v = query[k].normalize();

    if (!_word_data_map.default.hasOwnProperty(k) || !_word_data_map.default[k].hasOwnProperty([v])) {
      throw {
        "error": `Sorry but '${k}'='${v}' does not exist in the word data.`
      };
    }

    query_matches.push(_doFilter(filter, _word_data_map.default[k][v], chapterFilter));
  });
  return (0, _util.arrayIntersect)(...query_matches);
};

exports._wordsThatMatchQuery = _wordsThatMatchQuery;

const _queryForWids = ({
  queryArray,
  search_range,
  search_filter
}) => {
  let word_matches = [];
  let exclusions = [];
  let current_match = -1;
  let starttime = process.hrtime();
  queryArray.forEach(query => {
    consoleLog("BENCHMARK Q: foreach cycle ", process.hrtime(starttime));

    const query_matches = _wordsThatMatchQuery(query.data, search_filter);

    if (query.invert) exclusions.push(...query_matches);else word_matches.push(query_matches);
  });
  consoleLog("BENCHMARK Q: done with foreach", process.hrtime(starttime));
  const sr_matches = word_matches.map(m => m.map(n => _tree_data.default[n][search_range]));
  const sr_exclusions = exclusions.map(m => _tree_data.default[m][search_range]);
  const match_intersection = (0, _util.arrayIntersect)(...sr_matches);
  const range_matches = (0, _util.arrayDiff)(match_intersection, sr_exclusions);
  consoleLog("BENCHMARK Q: done intersecting", process.hrtime(starttime));
  const word_match_indices_map = word_matches.map(w => w.reduce((a, v) => {
    if (!a.hasOwnProperty(_tree_data.default[v][search_range])) a[_tree_data.default[v][search_range]] = [];

    a[_tree_data.default[v][search_range]].push(v);

    return a;
  }, {}));
  const range_matches_with_unique_limit = range_matches.map((r, i) => {
    const word_match_indices = word_match_indices_map.map((w, i) => w[r]);
    const should_include = (0, _uniqueValuePerArray.uniqueValuePerArray)(word_match_indices) ? word_match_indices : false;
    return {
      sr_node: r,
      matching_word_nodes: should_include
    };
  }).filter(m => m && m.matching_word_nodes !== false);
  consoleLog("BENCHMARK Q: query el indep. repr.", process.hrtime(starttime));
  consoleLog("RESULTS:", range_matches_with_unique_limit.length);
  return range_matches_with_unique_limit;
};

const termSearch = (params, db) => {
  return new Promise((resolve, reject) => {
    let starttime = process.hrtime();
    consoleLog("BENCHMARK: **querying for WIDS", process.hrtime(starttime));

    const matches = _queryForWids({
      queryArray: params["query"],
      search_range: params["search_range"] || "clause",
      search_filter: params["search_filter"] || []
    });

    let truncated = false;

    if (matches.length > RESULT_LIMIT) {
      truncated = matches.length;
      matches.splice(RESULT_LIMIT);
    }

    consoleLog("BENCHMARK: **getting matching word sets", process.hrtime(starttime));
    const words_in_matching_ranges_set = new Set(matches.reduce((c, m) => c.concat(..._range_node_data.default[m.sr_node]["wids"]), []));
    const all_word_matches = matches.reduce((c, n) => c.concat(...n.matching_word_nodes), []);
    const actual_matching_words_set = new Set((0, _util.arrayIntersect)(all_word_matches, words_in_matching_ranges_set)); // Allowed texts

    const paramTexts = params["texts"] || [];
    const allowedTexts = ["wlc", "net", "lxx"];
    let textsToReturn = allowedTexts.filter(f => paramTexts.indexOf(f) !== -1);
    if (textsToReturn.length === 0) textsToReturn = ["wlc", "net"];
    consoleLog("BENCHMARK: **now formulating final data", process.hrtime(starttime));
    const ridmatches = matches.reduce((c, n) => c.concat(..._range_node_data.default[n.sr_node]["rids"]), []);
    (0, _chapterText.ridlistText)(ridmatches, new Set(textsToReturn), db).then(ridMatchText => {
      const heatedMatchText = ridMatchText.map(matchingObject => {
        matchingObject["wlc"] = heatUpVerseWords(matchingObject["wlc"], actual_matching_words_set, words_in_matching_ranges_set);
        return matchingObject;
      });
      consoleLog("BENCHMARK: **results now being processed", process.hrtime(starttime));
      const match_result_data = matches.map(m => {
        const ridTextArray = [];

        _range_node_data.default[m.sr_node]["rids"].forEach(rid => {
          ridTextArray.push(heatedMatchText.find(t => t.rid === rid));
        });

        return {
          "node": m.sr_node,
          "verses": _range_node_data.default[m.sr_node]["rids"],
          "text": ridTextArray
        };
      });
      const response = {
        "truncated": truncated,
        "results": match_result_data
      };
      resolve(response);
      consoleLog("BENCHMARK: **done", process.hrtime(starttime));
      consoleLog(`TermSearch: ${match_result_data.length} results (${process.hrtime(starttime)})`);
    }).catch();
  });
};

exports.termSearch = termSearch;

const collocationSearch = params => {
  const grouping_key = "voc_utf8";
  return new Promise((resolve, reject) => {
    // TODO: the syntax of _queryForWids has changed since this line...
    // !!!!!!!!!!!!!!
    const {
      word_matches
    } = _queryForWids({
      queryArray: params["query"],
      search_range: params["search_range"]
    }); // params["whitelist"] == ["Verb"]


    const word_match_morph = word_matches.map(wid => _word_data_map.default[wid][grouping_key]);
    const tally_match_data = word_match_morph.reduce((c, k) => {
      if (!c.hasOwnProperty(k)) c[k] = 0;
      c[k]++;
      return c;
    }, {});
    const response = {
      "length": Object.keys(tally_match_data).length,
      "results": tally_match_data
    };
    resolve(response);
  });
};

exports.collocationSearch = collocationSearch;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvdGVybS1zZWFyY2guanMiXSwibmFtZXMiOlsiUkVTVUxUX0xJTUlUIiwiZG9Mb2ciLCJjb25zb2xlTG9nIiwiZGVidWciLCJjb25zb2xlIiwibG9nIiwiaGVhdFVwVmVyc2VXb3JkcyIsInZlcnNlX3dvcmRzIiwiaG90X3NldCIsImx1a2V3YXJtX3NldCIsIm1hcCIsImFjY2VudFVuaXQiLCJ3IiwiaGFzIiwiX2RvRmlsdGVyIiwiZmlsdGVyIiwid29yZE5vZGVzIiwiY2hhcHRlckZpbHRlciIsImxlbmd0aCIsImNoYXB0ZXJPZmZzZXQiLCJyaWRGaWx0ZXIiLCJmIiwiYm9va19uYW1lcyIsImV4dGVudCIsInJpZCIsInRyZWVfZGF0YSIsInZlcnNlIiwicmVkdWNlIiwiYSIsInYiLCJfd29yZHNUaGF0TWF0Y2hRdWVyeSIsInF1ZXJ5IiwicXVlcnlfbWF0Y2hlcyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwiayIsIm5vcm1hbGl6ZSIsIndvcmRfZGF0YSIsImhhc093blByb3BlcnR5IiwicHVzaCIsIl9xdWVyeUZvcldpZHMiLCJxdWVyeUFycmF5Iiwic2VhcmNoX3JhbmdlIiwic2VhcmNoX2ZpbHRlciIsIndvcmRfbWF0Y2hlcyIsImV4Y2x1c2lvbnMiLCJjdXJyZW50X21hdGNoIiwic3RhcnR0aW1lIiwicHJvY2VzcyIsImhydGltZSIsImRhdGEiLCJpbnZlcnQiLCJzcl9tYXRjaGVzIiwibSIsIm4iLCJzcl9leGNsdXNpb25zIiwibWF0Y2hfaW50ZXJzZWN0aW9uIiwicmFuZ2VfbWF0Y2hlcyIsIndvcmRfbWF0Y2hfaW5kaWNlc19tYXAiLCJyYW5nZV9tYXRjaGVzX3dpdGhfdW5pcXVlX2xpbWl0IiwiciIsImkiLCJ3b3JkX21hdGNoX2luZGljZXMiLCJzaG91bGRfaW5jbHVkZSIsInNyX25vZGUiLCJtYXRjaGluZ193b3JkX25vZGVzIiwidGVybVNlYXJjaCIsInBhcmFtcyIsImRiIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJtYXRjaGVzIiwidHJ1bmNhdGVkIiwic3BsaWNlIiwid29yZHNfaW5fbWF0Y2hpbmdfcmFuZ2VzX3NldCIsIlNldCIsImMiLCJjb25jYXQiLCJyYW5nZV9ub2RlX2RhdGEiLCJhbGxfd29yZF9tYXRjaGVzIiwiYWN0dWFsX21hdGNoaW5nX3dvcmRzX3NldCIsInBhcmFtVGV4dHMiLCJhbGxvd2VkVGV4dHMiLCJ0ZXh0c1RvUmV0dXJuIiwiaW5kZXhPZiIsInJpZG1hdGNoZXMiLCJ0aGVuIiwicmlkTWF0Y2hUZXh0IiwiaGVhdGVkTWF0Y2hUZXh0IiwibWF0Y2hpbmdPYmplY3QiLCJtYXRjaF9yZXN1bHRfZGF0YSIsInJpZFRleHRBcnJheSIsImZpbmQiLCJ0IiwicmVzcG9uc2UiLCJjYXRjaCIsImNvbGxvY2F0aW9uU2VhcmNoIiwiZ3JvdXBpbmdfa2V5Iiwid29yZF9tYXRjaF9tb3JwaCIsIndpZCIsInRhbGx5X21hdGNoX2RhdGEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQUVBLE1BQU1BLFlBQVksR0FBRyxHQUFyQjtBQUVBLE1BQU1DLEtBQUssR0FBRyxLQUFkOztBQUNBLE1BQU1DLFVBQVUsR0FBRyxDQUFDLEdBQUdDLEtBQUosS0FBYztBQUNoQyxNQUFJRixLQUFKLEVBQVc7QUFDVkcsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksR0FBR0YsS0FBZjtBQUNBO0FBQ0QsQ0FKRDs7QUFNQSxNQUFNRyxnQkFBZ0IsR0FBRyxDQUFDQyxXQUFELEVBQWNDLE9BQWQsRUFBdUJDLFlBQXZCLEtBQXdDO0FBQ2hFLFNBQU9GLFdBQVcsQ0FBQ0csR0FBWixDQUFnQkMsVUFBVSxJQUNoQ0EsVUFBVSxDQUFDRCxHQUFYLENBQWVFLENBQUMsSUFBSTtBQUNuQixRQUFJSixPQUFPLENBQUNLLEdBQVIsQ0FBWUQsQ0FBQyxDQUFDLEtBQUQsQ0FBYixDQUFKLEVBQ0NBLENBQUMsQ0FBQyxhQUFELENBQUQsR0FBbUIs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Q0FEb0I7QUFFdEN6QixNQUFBQSxZQUFZLEVBQUV5QixNQUFNLENBQUMsY0FBRDtBQUZrQixLQUFELENBQXRDLENBSHVDLENBT3ZDOzs7QUFDQSxVQUFNZ0MsZ0JBQWdCLEdBQUd2RCxZQUFZLENBQUNuQyxHQUFiLENBQWlCMkYsR0FBRyxJQUFJL0QsdUJBQVUrRCxHQUFWLEVBQWVGLFlBQWYsQ0FBeEIsQ0FBekI7QUFDQSxVQUFNRyxnQkFBZ0IsR0FBR0YsZ0JBQWdCLENBQUN6RSxNQUFqQixDQUF3QixDQUFDbUQsQ0FBRCxFQUFJMUMsQ0FBSixLQUFVO0FBQzFELFVBQUksQ0FBQzBDLENBQUMsQ0FBQ3ZDLGNBQUYsQ0FBaUJILENBQWpCLENBQUwsRUFDQzBDLENBQUMsQ0FBQzFDLENBQUQsQ0FBRCxHQUFPLENBQVA7QUFDRDBDLE1BQUFBLENBQUMsQ0FBQzFDLENBQUQsQ0FBRDtBQUNBLGFBQU8wQyxDQUFQO0FBQ0EsS0FMd0IsRUFLdEIsRUFMc0IsQ0FBekI7QUFPQSxVQUFNa0IsUUFBUSxHQUFHO0FBQ2hCLGdCQUFVL0QsTUFBTSxDQUFDQyxJQUFQLENBQVlvRSxnQkFBWixFQUE4QnBGLE1BRHhCO0FBRWhCLGlCQUFXb0Y7QUFGSyxLQUFqQjtBQUlBL0IsSUFBQUEsT0FBTyxDQUFDeUIsUUFBRCxDQUFQO0FBQ0EsR0FyQk0sQ0FBUDtBQXNCQSxDQXhCRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFycmF5RGlmZiwgYXJyYXlJbnRlcnNlY3QgfSBmcm9tICcuLi91dGlsL3V0aWwnXG5pbXBvcnQgeyB1bmlxdWVWYWx1ZVBlckFycmF5IH0gZnJvbSAnLi4vdXRpbC91bmlxdWVWYWx1ZVBlckFycmF5J1xuaW1wb3J0IHsgcmlkbGlzdFRleHQgfSBmcm9tICcuL2NoYXB0ZXItdGV4dCdcblxuaW1wb3J0IHdvcmRfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3dvcmRfZGF0YV9tYXAnXG5pbXBvcnQgdHJlZV9kYXRhIGZyb20gJy4uLy4uL2RhdGEvdHJlZV9kYXRhJ1xuaW1wb3J0IHJhbmdlX25vZGVfZGF0YSBmcm9tICcuLi8uLi9kYXRhL3JhbmdlX25vZGVfZGF0YSdcbmltcG9ydCBib29rX25hbWVzIGZyb20gJy4uLy4uL2RhdGEvYm9va19uYW1lcydcblxuY29uc3QgUkVTVUxUX0xJTUlUID0gNTAwXG5cbmNvbnN0IGRvTG9nID0gZmFsc2VcbmNvbnN0IGNvbnNvbGVMb2cgPSAoLi4uZGVidWcpID0+IHtcblx0aWYgKGRvTG9nKSB7XG5cdFx0Y29uc29sZS5sb2coLi4uZGVidWcpXG5cdH1cbn1cblxuY29uc3QgaGVhdFVwVmVyc2VXb3JkcyA9ICh2ZXJzZV93b3JkcywgaG90X3NldCwgbHVrZXdhcm1fc2V0KSA9PiB7XG5cdHJldHVybiB2ZXJzZV93b3Jkcy5tYXAoYWNjZW50VW5pdCA9PlxuXHRcdGFjY2VudFVuaXQubWFwKHcgPT4ge1xuXHRcdFx0aWYgKGhvdF9zZXQuaGFzKHdbXCJ3aWRcIl0pKVxuXHRcdFx0XHR3W1widGVtcGVyYXR1cmVcIl0gPSAyXG5cdFx0XHRlbHNlIGlmIChsdWtld2FybV9zZXQuaGFzKHdbXCJ3aWRcIl0pKVxuXHRcdFx0XHR3W1widGVtcGVyYXR1cmVcIl0gPSAxXG5cdFx0XHRyZXR1cm4gd1xuXHRcdH0pXG5cdClcbn1cblxuY29uc3QgX2RvRmlsdGVyID0gKGZpbHRlciwgd29yZE5vZGVzLCBjaGFwdGVyRmlsdGVyID0gMCkgPT4ge1xuXHRpZiAoZmlsdGVyLmxlbmd0aCA+IDApIHtcblx0XHRjb25zdCBjaGFwdGVyT2Zmc2V0ID0gY2hhcHRlckZpbHRlciAqIDEwMDBcblx0XHRjb25zdCByaWRGaWx0ZXIgPSBmaWx0ZXIubWFwKGYgPT4gYm9va19uYW1lc1tmXSAqIDEwMDAwMDAwICsgY2hhcHRlck9mZnNldClcblxuXHRcdGNvbnN0IGV4dGVudCA9IGNoYXB0ZXJGaWx0ZXIgPT09IDAgPyAxMDAwMDAwMCA6IDEwMDBcblx0XHRyZXR1cm4gd29yZE5vZGVzLmZpbHRlcih3ID0+IHtcblx0XHRcdGNvbnN0IHJpZCA9IHRyZWVfZGF0YVt3XS52ZXJzZVxuXHRcdFx0cmV0dXJuIHJpZEZpbHRlci5yZWR1Y2UoKGEsIHYpID0+IGEgfHwgdiA8PSByaWQgJiYgcmlkIDwgdiArIGV4dGVudCwgZmFsc2UpXG5cdFx0fSlcblx0fVxuXHRlbHNlIHtcblx0XHRyZXR1cm4gd29yZE5vZGVzXG5cdH1cbn1cbmNvbnN0IF93b3Jkc1RoYXRNYXRjaFF1ZXJ5ID0gKHF1ZXJ5LCBmaWx0ZXIsIGNoYXB0ZXJGaWx0ZXIgPSAwKSA9PiB7XG5cdGxldCBxdWVyeV9tYXRjaGVzID0gW11cblx0T2JqZWN0LmtleXMocXVlcnkpLmZvckVhY2goKGspID0+IHtcblx0XHRjb25zdCB2ID0gcXVlcnlba10ubm9ybWFsaXplKClcblx0XHRpZiAoIXdvcmRfZGF0YS5oYXNPd25Qcm9wZXJ0eShrKSB8fCAhd29yZF9kYXRhW2tdLmhhc093blByb3BlcnR5KFt2XSkpIHtcblx0XHRcdHRocm93ICh7IFwiZXJyb3JcIjogYFNvcnJ5IGJ1dCAnJHtrfSc9JyR7dn0nIGRvZXMgbm90IGV4aXN0IGluIHRoZSB3b3JkIGRhdGEuYCB9KVxuXHRcdH1cblx0XHRxdWVyeV9tYXRjaGVzLnB1c2goX2RvRmlsdGVyKGZpbHRlciwgd29yZF9kYXRhW2tdW3ZdLCBjaGFwdGVyRmlsdGVyKSlcblx0fSlcblx0cmV0dXJuIGFycmF5SW50ZXJzZWN0KC4uLnF1ZXJ5X21hdGNoZXMpXG59XG5jb25zdCBfcXVlcnlGb3JXaWRzID0gKHsgcXVlcnlBcnJheSwgc2VhcmNoX3JhbmdlLCBzZWFyY2hfZmlsdGVyIH0pID0+IHtcblx0bGV0IHdvcmRfbWF0Y2hlcyA9IFtdXG5cdGxldCBleGNsdXNpb25zID0gW11cblx0bGV0IGN1cnJlbnRfbWF0Y2ggPSAtMVxuXHRsZXQgc3RhcnR0aW1lID0gcHJvY2Vzcy5ocnRpbWUoKVxuXHRxdWVyeUFycmF5LmZvckVhY2goKHF1ZXJ5KSA9PiB7XG5cdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSyBROiBmb3JlYWNoIGN5Y2xlIFwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IHF1ZXJ5X21hdGNoZXMgPSBfd29yZHNUaGF0TWF0Y2hRdWVyeShxdWVyeS5kYXRhLCBzZWFyY2hfZmlsdGVyKVxuXG5cdFx0aWYgKHF1ZXJ5LmludmVydClcblx0XHRcdGV4Y2x1c2lvbnMucHVzaCguLi5xdWVyeV9tYXRjaGVzKVxuXHRcdGVsc2Vcblx0XHRcdHdvcmRfbWF0Y2hlcy5wdXNoKHF1ZXJ5X21hdGNoZXMpXG5cdH0pXG5cdGNvbnNvbGVMb2coXCJCRU5DSE1BUksgUTogZG9uZSB3aXRoIGZvcmVhY2hcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblxuXHRjb25zdCBzcl9tYXRjaGVzID0gd29yZF9tYXRjaGVzLm1hcChtID0+IG0ubWFwKG4gPT4gdHJlZV9kYXRhW25dW3NlYXJjaF9yYW5nZV0pKVxuXHRjb25zdCBzcl9leGNsdXNpb25zID0gZXhjbHVzaW9ucy5tYXAobSA9PiB0cmVlX2RhdGFbbV1bc2VhcmNoX3JhbmdlXSlcblx0Y29uc3QgbWF0Y2hfaW50ZXJzZWN0aW9uID0gYXJyYXlJbnRlcnNlY3QoLi4uc3JfbWF0Y2hlcylcblx0Y29uc3QgcmFuZ2VfbWF0Y2hlcyA9IGFycmF5RGlmZihtYXRjaF9pbnRlcnNlY3Rpb24sIHNyX2V4Y2x1c2lvbnMpXG5cblx0Y29uc29sZUxvZyhcIkJFTkNITUFSSyBROiBkb25lIGludGVyc2VjdGluZ1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRjb25zdCB3b3JkX21hdGNoX2luZGljZXNfbWFwID0gd29yZF9tYXRjaGVzLm1hcCh3ID0+IHcucmVkdWNlKChhLCB2KSA9PiB7XG5cdFx0aWYgKCFhLmhhc093blByb3BlcnR5KHRyZWVfZGF0YVt2XVtzZWFyY2hfcmFuZ2VdKSlcblx0XHRcdGFbdHJlZV9kYXRhW3ZdW3NlYXJjaF9yYW5nZV1dID0gW11cblx0XHRhW3RyZWVfZGF0YVt2XVtzZWFyY2hfcmFuZ2VdXS5wdXNoKHYpXG5cdFx0cmV0dXJuIGFcblx0fSwge30pKVxuXHRjb25zdCByYW5nZV9tYXRjaGVzX3dpdGhfdW5pcXVlX2xpbWl0ID0gcmFuZ2VfbWF0Y2hlcy5tYXAoKHIsIGkpID0+IHtcblx0XHRjb25zdCB3b3JkX21hdGNoX2luZGljZXMgPSB3b3JkX21hdGNoX2luZGljZXNfbWFwLm1hcCgodywgaSkgPT4gd1tyXSlcblx0XHRjb25zdCBzaG91bGRfaW5jbHVkZSA9IHVuaXF1ZVZhbHVlUGVyQXJyYXkod29yZF9tYXRjaF9pbmRpY2VzKSA/IHdvcmRfbWF0Y2hfaW5kaWNlcyA6IGZhbHNlXG5cdFx0cmV0dXJuIHtcblx0XHRcdHNyX25vZGU6IHIsXG5cdFx0XHRtYXRjaGluZ193b3JkX25vZGVzOiBzaG91bGRfaW5jbHVkZVxuXHRcdH1cblx0fSlcblx0XHQuZmlsdGVyKG0gPT4gbSAmJiBtLm1hdGNoaW5nX3dvcmRfbm9kZXMgIT09IGZhbHNlKVxuXHRjb25zb2xlTG9nKFwiQkVOQ0hNQVJLIFE6IHF1ZXJ5IGVsIGluZGVwLiByZXByLlwiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRjb25zb2xlTG9nKFwiUkVTVUxUUzpcIiwgcmFuZ2VfbWF0Y2hlc193aXRoX3VuaXF1ZV9saW1pdC5sZW5ndGgpXG5cdHJldHVybiByYW5nZV9tYXRjaGVzX3dpdGhfdW5pcXVlX2xpbWl0XG59XG5cbmNvbnN0IHRlcm1TZWFyY2ggPSAocGFyYW1zLCBkYikgPT4ge1xuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdGxldCBzdGFydHRpbWUgPSBwcm9jZXNzLmhydGltZSgpXG5cdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogKipxdWVyeWluZyBmb3IgV0lEU1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IG1hdGNoZXMgPSBfcXVlcnlGb3JXaWRzKHtcblx0XHRcdHF1ZXJ5QXJyYXk6IHBhcmFtc1tcInF1ZXJ5XCJdLFxuXHRcdFx0c2VhcmNoX3JhbmdlOiBwYXJhbXNbXCJzZWFyY2hfcmFuZ2VcIl0gfHwgXCJjbGF1c2VcIixcblx0XHRcdHNlYXJjaF9maWx0ZXI6IHBhcmFtc1tcInNlYXJjaF9maWx0ZXJcIl0gfHwgW11cblx0XHR9KVxuXHRcdGxldCB0cnVuY2F0ZWQgPSBmYWxzZVxuXHRcdGlmIChtYXRjaGVzLmxlbmd0aCA+IFJFU1VMVF9MSU1JVCkge1xuXHRcdFx0dHJ1bmNhdGVkID0gbWF0Y2hlcy5sZW5ndGhcblx0XHRcdG1hdGNoZXMuc3BsaWNlKFJFU1VMVF9MSU1JVClcblx0XHR9XG5cdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogKipnZXR0aW5nIG1hdGNoaW5nIHdvcmQgc2V0c1wiLCBwcm9jZXNzLmhydGltZShzdGFydHRpbWUpKVxuXHRcdGNvbnN0IHdvcmRzX2luX21hdGNoaW5nX3Jhbmdlc19zZXQgPSBuZXcgU2V0KG1hdGNoZXMucmVkdWNlKChjLCBtKSA9PiBjLmNvbmNhdCguLi5yYW5nZV9ub2RlX2RhdGFbbS5zcl9ub2RlXVtcIndpZHNcIl0pLCBbXSkpXG5cdFx0Y29uc3QgYWxsX3dvcmRfbWF0Y2hlcyA9IG1hdGNoZXMucmVkdWNlKChjLCBuKSA9PiBjLmNvbmNhdCguLi5uLm1hdGNoaW5nX3dvcmRfbm9kZXMpLCBbXSlcblx0XHRjb25zdCBhY3R1YWxfbWF0Y2hpbmdfd29yZHNfc2V0ID0gbmV3IFNldChhcnJheUludGVyc2VjdChhbGxfd29yZF9tYXRjaGVzLCB3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0KSlcblxuXHRcdC8vIEFsbG93ZWQgdGV4dHNcblx0XHRjb25zdCBwYXJhbVRleHRzID0gcGFyYW1zW1widGV4dHNcIl0gfHwgW11cblx0XHRjb25zdCBhbGxvd2VkVGV4dHMgPSBbXCJ3bGNcIiwgXCJuZXRcIiwgXCJseHhcIl1cblx0XHRsZXQgdGV4dHNUb1JldHVybiA9IGFsbG93ZWRUZXh0cy5maWx0ZXIoZiA9PiBwYXJhbVRleHRzLmluZGV4T2YoZikgIT09IC0xKVxuXHRcdGlmICh0ZXh0c1RvUmV0dXJuLmxlbmd0aCA9PT0gMClcblx0XHRcdHRleHRzVG9SZXR1cm4gPSBbXCJ3bGNcIiwgXCJuZXRcIl1cblxuXHRcdGNvbnNvbGVMb2coXCJCRU5DSE1BUks6ICoqbm93IGZvcm11bGF0aW5nIGZpbmFsIGRhdGFcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblx0XHRjb25zdCByaWRtYXRjaGVzID0gbWF0Y2hlcy5yZWR1Y2UoKGMsIG4pID0+IGMuY29uY2F0KC4uLnJhbmdlX25vZGVfZGF0YVtuLnNyX25vZGVdW1wicmlkc1wiXSksIFtdKVxuXHRcdHJpZGxpc3RUZXh0KHJpZG1hdGNoZXMsIG5ldyBTZXQodGV4dHNUb1JldHVybiksIGRiKS50aGVuKChyaWRNYXRjaFRleHQpID0+IHtcblx0XHRcdGNvbnN0IGhlYXRlZE1hdGNoVGV4dCA9IHJpZE1hdGNoVGV4dC5tYXAobWF0Y2hpbmdPYmplY3QgPT4ge1xuXHRcdFx0XHRtYXRjaGluZ09iamVjdFtcIndsY1wiXSA9IGhlYXRVcFZlcnNlV29yZHMoXG5cdFx0XHRcdFx0bWF0Y2hpbmdPYmplY3RbXCJ3bGNcIl0sXG5cdFx0XHRcdFx0YWN0dWFsX21hdGNoaW5nX3dvcmRzX3NldCxcblx0XHRcdFx0XHR3b3Jkc19pbl9tYXRjaGluZ19yYW5nZXNfc2V0XG5cdFx0XHRcdClcblx0XHRcdFx0cmV0dXJuIG1hdGNoaW5nT2JqZWN0XG5cdFx0XHR9KVxuXHRcdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogKipyZXN1bHRzIG5vdyBiZWluZyBwcm9jZXNzZWRcIiwgcHJvY2Vzcy5ocnRpbWUoc3RhcnR0aW1lKSlcblx0XHRcdGNvbnN0IG1hdGNoX3Jlc3VsdF9kYXRhID0gbWF0Y2hlcy5tYXAoKG0pID0+IHtcblx0XHRcdFx0Y29uc3QgcmlkVGV4dEFycmF5ID0gW11cblx0XHRcdFx0cmFuZ2Vfbm9kZV9kYXRhW20uc3Jfbm9kZV1bXCJyaWRzXCJdLmZvckVhY2gocmlkID0+IHtcblx0XHRcdFx0XHRyaWRUZXh0QXJyYXkucHVzaChoZWF0ZWRNYXRjaFRleHQuZmluZCh0ID0+IHQucmlkID09PSByaWQpKVxuXHRcdFx0XHR9KVxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdFwibm9kZVwiOiBtLnNyX25vZGUsXG5cdFx0XHRcdFx0XCJ2ZXJzZXNcIjogcmFuZ2Vfbm9kZV9kYXRhW20uc3Jfbm9kZV1bXCJyaWRzXCJdLFxuXHRcdFx0XHRcdFwidGV4dFwiOiByaWRUZXh0QXJyYXlcblx0XHRcdFx0fVxuXHRcdFx0fSlcblxuXHRcdFx0Y29uc3QgcmVzcG9uc2UgPSB7XG5cdFx0XHRcdFwidHJ1bmNhdGVkXCI6IHRydW5jYXRlZCxcblx0XHRcdFx0XCJyZXN1bHRzXCI6IG1hdGNoX3Jlc3VsdF9kYXRhXG5cdFx0XHR9XG5cdFx0XHRyZXNvbHZlKHJlc3BvbnNlKVxuXHRcdFx0Y29uc29sZUxvZyhcIkJFTkNITUFSSzogKipkb25lXCIsIHByb2Nlc3MuaHJ0aW1lKHN0YXJ0dGltZSkpXG5cdFx0XHRjb25zb2xlTG9nKGBUZXJtU2VhcmNoOiAke21hdGNoX3Jlc3VsdF9kYXRhLmxlbmd0aH0gcmVzdWx0cyAoJHtwcm9jZXNzLmhydGltZShzdGFydHRpbWUpfSlgKVxuXHRcdH0pLmNhdGNoKClcblx0fSlcbn1cblxuY29uc3QgY29sbG9jYXRpb25TZWFyY2ggPSAocGFyYW1zKSA9PiB7XG5cdGNvbnN0IGdyb3VwaW5nX2tleSA9IFwidm9jX3V0ZjhcIlxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXHRcdC8vIFRPRE86IHRoZSBzeW50YXggb2YgX3F1ZXJ5Rm9yV2lkcyBoYXMgY2hhbmdlZCBzaW5jZSB0aGlzIGxpbmUuLi5cblx0XHQvLyAhISEhISEhISEhISEhIVxuXHRcdGNvbnN0IHsgd29yZF9tYXRjaGVzIH0gPSBfcXVlcnlGb3JXaWRzKHtcblx0XHRcdHF1ZXJ5QXJyYXk6IHBhcmFtc1tcInF1ZXJ5XCJdLFxuXHRcdFx0c2VhcmNoX3JhbmdlOiBwYXJhbXNbXCJzZWFyY2hfcmFuZ2VcIl1cblx0XHR9KVxuXHRcdC8vIHBhcmFtc1tcIndoaXRlbGlzdFwiXSA9PSBbXCJWZXJiXCJdXG5cdFx0Y29uc3Qgd29yZF9tYXRjaF9tb3JwaCA9IHdvcmRfbWF0Y2hlcy5tYXAod2lkID0+IHdvcmRfZGF0YVt3aWRdW2dyb3VwaW5nX2tleV0pXG5cdFx0Y29uc3QgdGFsbHlfbWF0Y2hfZGF0YSA9IHdvcmRfbWF0Y2hfbW9ycGgucmVkdWNlKChjLCBrKSA9PiB7XG5cdFx0XHRpZiAoIWMuaGFzT3duUHJvcGVydHkoaykpXG5cdFx0XHRcdGNba10gPSAwXG5cdFx0XHRjW2tdKytcblx0XHRcdHJldHVybiBjXG5cdFx0fSwge30pXG5cblx0XHRjb25zdCByZXNwb25zZSA9IHtcblx0XHRcdFwibGVuZ3RoXCI6IE9iamVjdC5rZXlzKHRhbGx5X21hdGNoX2RhdGEpLmxlbmd0aCxcblx0XHRcdFwicmVzdWx0c1wiOiB0YWxseV9tYXRjaF9kYXRhXG5cdFx0fVxuXHRcdHJlc29sdmUocmVzcG9uc2UpXG5cdH0pXG59XG5cbmV4cG9ydCB7IHRlcm1TZWFyY2gsIGNvbGxvY2F0aW9uU2VhcmNoLCBfd29yZHNUaGF0TWF0Y2hRdWVyeSB9Il19